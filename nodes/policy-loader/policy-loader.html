<script type="text/javascript">
  (function () {
    "use strict";
  
    if (window.__TRADING_POLICY_GLOBAL__) return;
    window.__TRADING_POLICY_GLOBAL__ = true;
  
    console.log("[TradingPolicy] GLOBAL policy loaded");
  
    const ALLOWED = {
      ticker: ["indicator"],
      indicator: ["indicator", "conditions", "backtest"],
      conditions: ["backtest"],
      backtest: []
    };
  
    function validateAllLinks(origin) {
      RED.nodes.eachLink(function (link) {
        const src = RED.nodes.node(link.source.id);
        const tgt = RED.nodes.node(link.target.id);
  
        if (!src || !tgt) return;
  
        const allowedTargets = ALLOWED[src.type] || [];
  
        if (!allowedTargets.includes(tgt.type)) {
          console.warn(
            `[TradingPolicy] forbidden ${src.type} -> ${tgt.type}`
          );
  
          RED.nodes.removeLink(link);
  
          RED.notify(
            `Connexion interdite : ${src.type} â†’ ${tgt.type}`,
            "error"
          );
        }
      });
    }
  
    RED.events.on("links:add", () => validateAllLinks("links"));
    RED.events.on("nodes:add", () => validateAllLinks("nodes"));
    RED.events.on("workspace:change", () => validateAllLinks("workspace"));
  
    setTimeout(() => validateAllLinks("initial"), 0);
  })();
  </script>
  