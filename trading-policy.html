<script type="text/javascript">
    (function () {
      "use strict";
    
      // ðŸ”µ Trace de rechargement du fichier Ã©diteur
      console.log("[TradingPolicy] editor file reloaded", Date.now());
    
      // =====================================================
      // POLICY ENGINE (Ã©diteur, singleton)
      // =====================================================
      if (!window.__TRADING_POLICY_ENGINE__) {
    
        const DEBUG = true;
        const PREFIX = "[TradingPolicy]";
    
        function log(...args) {
          if (DEBUG) console.log(PREFIX, ...args);
        }
    
        function warn(...args) {
          if (DEBUG) console.warn(PREFIX, ...args);
        }
    
        const engine = {
          active: false,
          rules: [],
    
          addRule(fn) {
            if (typeof fn === "function") {
              this.rules.push(fn);
              log("rule added (count =", this.rules.length + ")");
            }
          },
    
          activate() {
            if (this.active) {
              log("already active");
              return;
            }
    
            this.active = true;
            log("activated");
    
            // ðŸ”´ Hook Ã‰DITEUR : links:add
            RED.events.on("links:add", (link) => {
              console.log("[TradingPolicy][DEBUG] links:add fired", link);
    
              // âš ï¸ CÃ”TÃ‰ Ã‰DITEUR : source/target SONT DÃ‰JÃ€ DES OBJETS
              const src = link.source && (link.source.target || link.source);
              const tgt = link.target && (link.target.target || link.target);
    
              console.log(
                "[TradingPolicy][DEBUG] resolved",
                src && src.type,
                "â†’",
                tgt && tgt.type
              );
   
              if (!src || !tgt) return;
    
              for (const rule of this.rules) {
                try {
                  if (rule(link, src, tgt)) {
                    warn("forbidden link", src.type, "â†’", tgt.type);
                    RED.nodes.removeLink(link);
                    RED.notify("Connexion interdite par la politique", "error");
                    break;
                  }
                } catch (e) {
                  console.error(PREFIX, "rule error", e);
                }
              }
            });
          }
        };
    
        // Exposition globale
        window.__TRADING_POLICY_ENGINE__ = engine;
        log("engine loaded");
    
        // =====================================================
        // ðŸ”´ RÃˆGLE TEMPORAIRE DE TEST
        // =====================================================
        engine.addRule((link, src, tgt) => {
          console.log(
            "[TradingPolicy][TEST RULE]",
            src.type,
            "â†’",
            tgt.type
          );
    
          // Interdire ticker â†’ backtest
          return (
            src.type === "trading-ticker" &&
            tgt.type === "trading-backtest"
          );
        });
      }
    
      // =====================================================
      // NODE Ã‰DITEUR (activateur)
      // =====================================================
      RED.nodes.registerType("trading-policy", {
        category: "trading",
        color: "#dddddd",
        defaults: {},
        inputs: 0,
        outputs: 0,
        label: "policy",
    
        oneditprepare() {
          console.log("[TradingPolicy] oneditprepare");
          window.__TRADING_POLICY_ENGINE__.activate();
        }
      });
    
    })();
    </script>
    